# План: посилання на NNS для донату, політика видалення кампаній, мультивалюта (ICP → BTC/ETH/USDT)

Нижче — детальний, поетапний план реалізації. Код не змінюємо; лише фіксуємо узгоджений дизайн та кроки впровадження.

## 1) Додати можливість поповнити кампанію зі свого гаманця прямо в dApp - має працювати для всіх користувачів - донаторів і автора

### Висновки з дослідження
  - «Open on Dashboard»: посилання `https://dashboard.internetcomputer.org/account/<accountId>` — показує деталізацію акаунта (для валідації адреси), але не ініціює переказ.
  - «One‑click transfer з DApp»: підписати виклик до ICP Ledger напряму через II користувача (без відкриття NNS). Це технічно можливо: фронтенд створює `HttpAgent` з II identity та викликає `ledger.account_balance_dfx`/`ledger.transfer` від імені користувача. Переказ виконується з його основного (або обраного) субакаунта.

### Запропонований UX‑flow (поетапно)
- Додати опцію «Send directly with II» (альтернатива відкриттю NNS) — вбудована форма: сума (ICP), опціональний memo, кнопка «Send». Під капотом — виклик ICP Ledger через `@dfinity/agent`, підписаний II користувача. 
- Валідувати баланс перед відправкою, показувати очікувану комісію (0.0001 ICP).


### Безпека, валідації, UX‑деталі
- Показувати checksum‑перевірку адреси (hex/довжина) перед копіюванням/відправкою.
- Відображати попередження про мережу (local/mainnet) та Canister host у DEV логах, але без шуму в PROD.
- Анти‑дублікати кліків: блокувати кнопку під час відправки; idempotent UI (toast + tx hash/height).
- Логи помилок з friendly повідомленнями (мережеві помилки, недостатній баланс, невірна адреса).

### Тестування
- Локально: мок Ledger (вже є `account_balance_dfx`) + e2e: копіювання адреси, відкриття NNS/Dashboard, формат QR.
- На mainnet: тестовий переказ з малого балансу на донат‑адресу; перевірка появи транзакції у Dashboard, правильності відображення балансу в DApp.

---

## 2) Політика видалення кампаній

### Бізнес‑правила
- Кампанії НЕ можна видаляти, якщо баланс > 0 (є токени/депозити) — щоб не «зникали кошти/історія».
- Видалення — лише власником (owner), після повного обнулення всіх прийнятих активів.
- Для звичайних користувачів кнопки «Delete» у UI не повинно бути взагалі.

### План змін (backend/UX/правила)
- Backend (коли з’явиться `deleteCampaign`):
  - Перевірка `caller == owner`.
  - Перевірка на нульові баланси по всіх активних токенах кампанії (ICP/ICRC‑1 тощо).
  - М’яке видалення (soft‑delete) або архівація з футпрінтом події (audit trail).
- Frontend:
  - Прибрати кнопку «Delete» у списку та на сторінці кампанії.
  - Якщо колись додамо — відображати лише власнику і тільки коли всі баланси == 0 (і валідацію повторювати на бекенді).
- Тести:
  - E2E: власник із нульовими балансами → видалення успішне; не власник → 403; ненульові баланси → 400.

---

## 3) Прийом платежів у інших валютах (ETC, BTC, USDT)

### Оцінка варіантів і пріоритезація
- Найпростішим для інтеграції в екосистемі ICP є ICRC‑токени, насамперед `ckBTC` (Bitcoin на ICP) та `ckETH`/`ckERC20` (за наявності). Вони працюють через Ledger‑подібні стандарти та добре тестуються у фронті.
- Прямі мережі (native BTC, Ethereum/ETC, USDT ERC20/TRC20) потребують генерації/зберігання ключів або сторонніх кастодіалів/Wallet‑as‑a‑Service. Це підвищена складність/ризики.

### Запропонований roadmap (по черзі)
1. Фаза 1 — `ckBTC` (рекомендовано почати саме з нього)
   - Тип: ICRC‑1 токен на ICP. Швидкі та дешеві транзакції, прозора інтеграція через агент.
   - Дії:
     - Зберігати для кампанії ICRC‑account (аналог ICP accountId) — можна перевикористати існуючу схему субакаунтів.
     - Додати відображення `ckBTC` у списку токенів кампанії (баланс, QR/адреса у форматі ICRC‑account).
     - Отримання балансу: ICRC‑1 `icrc1_balance_of` через Actor.
     - Тести: локальні мок‑відповіді + mainnet перевірка невеликих переказів.
2. Фаза 2 — `ckETH` / `ckERC20` (за наявності стабільної підтримки)
   - Тип: ICRC‑подібні токени, інтегровані через Chain Fusion.
   - Дії:
     - Узгодити доступні токени (наприклад, `ckETH`, `ckUSDC`, потенційно `ckUSDT` якщо доступний).
     - Єдина абстракція для ICRC‑N токенів: баланс, формат адреси, символ/дробність.
     - Тести: швидкі транзакції на невеликі суми для UX перевірки.
3. Фаза 3 — Native BTC / ETH / USDT поза ICP (за потреби)
   - Варіант A: інтеграція з кастодіалом/WaaS (генерація адрес на кожну кампанію, webhooks про входження коштів).
   - Варіант B: Chain Fusion ECDSA для генерації адрес/UTXO‑сканування (висока складність, потребує окремого дизайну сервісу спостереження). 
   - Ризики: зберігання ключів, комісії, підтвердження блоків, KYC/AML залежно від юрисдикції.

### Крос‑токенова модель у фронті
- Єдиний компонент «TokenRow» із контрактним інтерфейсом: `symbol`, `decimals`, `getBalance()`, `address/qr`, `explorerLink` (за наявності).
- Політика відображення: показувати лише активовані токени кампанії (масив `acceptedTokens`).
- Кешування балансів (10–30 сек), оновлення без «миготіння» (поточний підхід із `startTransition` збережемо).

### Безпека й валідації
- Для ICRC (ck*) — стандартні перевірки адрес і обробка помилок агента.
- Для зовнішніх мереж — чітка сегментація конфігів (мережа, експлорери, підтвердження, комісії, мін. сума), відмова від зберігання ключів у нашому бекенді без вагомої причини.

### Тест‑план
- Юніт: перетворення форматів адрес/балансів, відмальовування компонентів.
- Інтеграційні: успішні перекази малих сум, обробка помилок мережі, таймаути.
- E2E: вибір токена → копіювання адреси/QR → перевірка приходу на баланс → ререндер без «сіпання».

---

## Організаційні домовленості
- Документація/правила додані в `.cursorrules` після релізу.
- Теги (`vX.Y.Z`) створюються ЛИШЕ за явною командою користувача; релізні точки позначаємо також `release/`‑гілками при потребі.

## Готовність до реалізації
- Етап А (NNS Open + буфер) і видалення кнопки — 0.5–1 роб. дня.
- `ckBTC` інтеграція (баланс+адреса+UI) — 1–2 роб. дні.
- «Send directly with II» (ICP) — 1–2 роб. дні з ретельним UX.
- Подальші токени — за пріоритетом та наявністю стабільних ICRC‑реалізацій. 